<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Doanh thu</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f8f8f8;
    }
    h2, h3 {
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #eee;
    }
    button {
      padding: 5px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    #invoiceModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #invoiceModal table {
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h2>üìä Doanh thu</h2>
  <label>Ch·ªçn ng√†y:
    <input type="date" id="dateFilter" />
  </label>
  <button onclick="loadRevenue()">Xem</button>
  <button onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
    <button onclick="clearAllHistory()">üóë X√≥a to√†n b·ªô</button>
  <h3 id="summary"></h3>

  <table>
    <thead>
      <tr>
        <th>S·ªë Hƒê</th>
        <th>B√†n</th>
        <th>Th·ªùi gian</th>
        <th>M√≥n ƒÉn</th>
        <th>T·ªïng ti·ªÅn</th>
        <th>Xem</th>
      </tr>
    </thead>
    <tbody id="revenueTable"></tbody>
  </table>

  <!-- Modal xem chi ti·∫øt -->
  <div id="invoiceModal">
    <div id="invoiceContent"></div>
    <div style="text-align:right; margin-top: 10px;">
      <button onclick="document.getElementById('invoiceModal').style.display='none'">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    function loadRevenue() {
      const tbody = document.getElementById('revenueTable');
      const dateInput = document.getElementById('dateFilter').value;
      const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');

      const rows = [];
      let totalRevenue = 0;

      history.forEach((invoice, i) => {
        const date = new Date(invoice.time);
        const dateStr = date.toISOString().slice(0, 10);
        if (!dateInput || dateStr === dateInput) {
          const timeStr = date.toLocaleTimeString('vi-VN');
          const items = invoice.orders.map(i => `${i.name} (x${i.qty})`).join(', ');
          rows.push(`<tr>
            <td>${invoice.invoiceId || ""}</td>
            <td>B√†n ${invoice.tableId}</td>
            <td>${dateStr} ${timeStr}</td>
            <td>${items}</td>
            <td>${invoice.total.toLocaleString()}ƒë</td>
            <td>
                <button onclick="viewInvoice(${i})">Xem</button>
                <button onclick="deleteInvoice(${i})">X√≥a</button>
                </td>
          </tr>`);
          totalRevenue += invoice.total;
        }
      });

      tbody.innerHTML = rows.join('');
      document.getElementById('summary').innerText = `üî¢ T·ªïng doanh thu: ${totalRevenue.toLocaleString()}ƒë`;
    }

    function viewInvoice(index) {
    const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
    const invoice = history[index];
    if (!invoice) return;

    const date = new Date(invoice.time);
    const dateStr = date.toLocaleDateString('vi-VN');
    const timeStr = date.toLocaleTimeString('vi-VN');
    const invoiceId = String(new Date(invoice.time).getTime()).slice(-6);

    let html = `
        <div style="font-family: monospace; font-size:14px;">
        <center>
            <h3 style="margin:5px 0;">NH√Ä H√ÄNG H·∫¢I S·∫¢N 007</h3>
            <div>CS2</div>
            <div>ƒêC: B√ÉI T·∫ÆM TT L·ªòC H√Ä - H√Ä Tƒ®NH</div>
            <div>ƒêT: 0974.726.447</div>
            <hr>
            <h3 style="margin:5px 0;">H√ìA ƒê∆†N B√ÅN H√ÄNG</h3>
            <div>B√ÄN ${invoice.tableId.toString().padStart(2, '0')}</div>
        </center>
        <div style="margin-top:10px;">Ng√†y: ${dateStr} &nbsp;&nbsp;&nbsp; S·ªë: ${invoiceId}</div>
        <div>Thu ng√¢n: Administrator &nbsp; In l√∫c: ${timeStr}</div>
        <div>Gi·ªù v√†o: ${timeStr} &nbsp;&nbsp;&nbsp; Gi·ªù ra: ${timeStr}</div>
        <hr>
        <table style="width: 100%; font-size: 13px;">
            <thead>
            <tr>
                <th style="text-align:left;">M·∫∑t h√†ng</th>
                <th style="text-align:center;">SL</th>
                <th style="text-align:center;">ƒêVT</th>
                <th style="text-align:right;">T.ti·ªÅn</th>
            </tr>
            </thead>
            <tbody>
    `;

    invoice.orders.forEach(item => {
        const itemTotal = (item.qty || 1) * (item.price || 0);
        html += `
        <tr>
            <td>${item.name}</td>
            <td style="text-align:center;">${item.qty}</td>
            <td style="text-align:center;">ƒëƒ©a</td>
            <td style="text-align:right;">${itemTotal.toLocaleString()}ƒë</td>
        </tr>`;
    });

    html += `
            </tbody>
        </table>
        <hr>
        <div style="text-align:right; font-size:16px;"><strong>T·ªïng c·ªông: ${invoice.total.toLocaleString()}ƒë</strong></div>
        <hr>
        <center><p>C·∫£m ∆°n Qu√Ω kh√°ch. H·∫πn g·∫∑p l·∫°i!</p></center>
        </div>
    `;

    document.getElementById('invoiceContent').innerHTML = html;
    document.getElementById('invoiceModal').style.display = 'block';
    }


    // Auto ch·ªçn h√¥m nay khi m·ªü trang
    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('dateFilter').value = today;
      loadRevenue();
    });
    //  xu·∫•t excel
    function exportToExcel() {
    const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
    if (history.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");

    const rows = [["B√†n", "Th·ªùi gian", "M√≥n ƒÉn", "S·ªë l∆∞·ª£ng", "ƒê∆°n gi√°", "Th√†nh ti·ªÅn"]];

    history.forEach(inv => {
        const date = new Date(inv.time);
        inv.orders.forEach(item => {
        const itemTotal = (item.qty || 0) * (item.price || 0);
        rows.push([
            "B√†n " + inv.tableId,
            date.toLocaleString('vi-VN'),
            item.name,
            item.qty,
            item.price,
            itemTotal
        ]);
        });
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DoanhThu");
    XLSX.writeFile(wb, "doanh_thu.xlsx");
    }
    function clearAllHistory() {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô h√≥a ƒë∆°n?")) return;
    localStorage.removeItem('invoiceHistory');
    loadRevenue();
    alert("üóë ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ h√≥a ƒë∆°n.");
    }
    function deleteInvoice(index) {
    if (!confirm("X√≥a h√≥a ƒë∆°n n√†y?")) return;
    const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
    history.splice(index, 1);
    localStorage.setItem('invoiceHistory', JSON.stringify(history));
    loadRevenue();
    }
  </script>
</body>
</html>
